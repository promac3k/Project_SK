<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="css/modal.css">
  <link rel="stylesheet" href="css/base.css">
  <link rel="stylesheet" href="css/profile.css">
  <script src="js/main.js"></script>
  <title>Perfil</title>
</head>

<body>
  <!-- Modal Erro ao alterar Palavra-Passe -->
  <div id="modal_erro" class="modal_erro">
    <div class="modal_erro_content">
      <span id="modalText"></span>
    </div>
  </div>
  <main>
    <div class="container_profile">

      <nav class="navbar">
        <ul>
          <li style="margin-left: 1.3rem; margin-right: auto;"><a href="/">Inicio</a></li>
          <li><a href="/contact">Contacto</a></li>
          <li><a href="/eventos">Eventos</a></li>
          <li class="adada"><a href="/perfil">Perfil</a></li>
        </ul>
      </nav>

      <div class="profile_info">
        <h1 id="nome"></h1>
        <img
          src="https://imgs.search.brave.com/wVvWqZjpOgQq0WR4gQEDL5FbT9OcgL64hPnC7RoI33o/rs:fit:860:0:0/g:ce/aHR0cHM6Ly9zdGF0/aWMtMDAuaWNvbmR1/Y2suY29tL2Fzc2V0/cy4wMC9wcm9ncmFt/bWVyLWljb24tMTAy/NHgxMDI0LW93ZTIy/bzd0LnBuZw"
          alt="" style="width:80%" class="img_perfil">
        <p class="title" id="curso"></p>
        <p class="title" id="turma"></p>
        <p class="title_2" id="escola"></p>
      </div>
      <div class="profile_settings">
        <span>
          <div class="social-container">
            <label class="switch_profile">
              <input id="switchon" type="checkbox" onclick="mySwitch()">
              <span class="slider round"></span>
            </label>
          </div>
        </span>
        <span id="password" style="cursor: pointer;"
          onclick="document.getElementById('modal_editar').style.display='block'"><img width="40" height="40"
            src="https://img.icons8.com/material-rounded/40/settings.png" alt="settings" class="opacityonhover" />
          </svg></span>
        <span id="mail" class="opacityonhover" style="cursor: pointer;"
          onclick="document.getElementById('modal_mensagem').style.display='block'"><img width="40" height="40"
            src="https://img.icons8.com/glyph-neue/40/mail.png" alt="mail" />
          </svg></span>
        <a href="/logout"><span><img width="40" height="40" src="https://img.icons8.com/windows/40/exit.png" alt="exit"
              class="img_settings" /></span></a>

      </div>

      <!-- Modal Editar Palavra-Passe -->
      <div id="modal_editar" class="modal">
        <div class="modal_conteudo">
          <div class="modal-header">
            <h1>Alterar Palavra-Passe</h1>

            <span class="fechar_editar" id="fechar">&times;</span>
          </div>

          <div class="modal-content">
            <div class="container_Pass">
              <form id="change-password-form" action="/change-password" method="post">
                <label for="lname">Palavra-Passe Antiga:</label><br>
                <input type="password" name="pass_antiga" class="input_campo"><br>
                <label for="lname">Nova Palavra-Passe:</label><br>
                <input type="password" name="pass_nova" class="input_campo"><br>
                <label for="email">Confirmar Palavra-Passe:</label><br>
                <input type="password" name="pass_confirme" class="input_campo"><br>
                <button type="submit" class="button_contacto">Gravar </button>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal mostra as mensagens -->
      <div id="modal_mensagem" class="modal">
        <div class="modal_conteudo">
          <div class="modal-header">
            <h1>Mensagens</h1>

            <span class="fechar_editar"
              onclick="document.getElementById('modal_mensagem').style.display='none'">&times;</span>
          </div>

          <div class="modal-content">
            <table class="email-table">
              <thead class="">
                <tr>
                  <th scope="col" style="text-align:center">De</th>
                  <th scope="col" style="text-align:center">Titulo</th>
                  <th scope="col" style="text-align:center">Mensagem</th>
                </tr>
              </thead>
              <tbody>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="flex-container" id="tabelaContainer">



        <table class="table_alunos">
          <thead>
            <tr class="tr_alunos">
              <th style="width: 200px;">Horas</th>
              <th style="width: 200px;">Segunda</th>
              <th style="width: 200px;">Terça</th>
              <th style="width: 200px;">Quarta</th>
              <th style="width: 200px;">Quinta</th>
              <th style="width: 200px;">Sexta</th>
              <th style="width: 200px;">Sábado</th>
            </tr>
          </thead>
          <tbody>
            <tr class="tr_alunos">
              <td>08:00 - 08:30</td>
              <td id="table_aula_segunda_08_00"></td>
              <td id="table_aula_terça_08_00"></td>
              <td id="table_aula_quarta_08_00"></td>
              <td id="table_aula_quinta_08_00"></td>
              <td id="table_aula_sexta_08_00"></td>
              <td id="table_aula_sabado_08_00"></td>
            </tr>
            <tr class="tr_alunos">
              <td>08:30 - 09:00</td>
              <td id="table_aula_segunda_08_30"></td>
              <td id="table_aula_terça_08_30"></td>
              <td id="table_aula_quarta_08_30"></td>
              <td id="table_aula_quinta_08_30"></td>
              <td id="table_aula_sexta_08_30"></td>
              <td id="table_aula_sabado_08_30"></td>
            </tr>
            <tr class="tr_alunos">
              <td>09:00 - 09:30</td>
              <td id="table_aula_segunda_09_00"></td>
              <td id="table_aula_terça_09_00"></td>
              <td id="table_aula_quarta_09_00"></td>
              <td id="table_aula_quinta_09_00"></td>
              <td id="table_aula_sexta_09_00"></td>
              <td id="table_aula_sabado_09_00"></td>
            </tr>
            <tr class="tr_alunos">
              <td>09:30 - 10:00</td>
              <td id="table_aula_segunda_09_30"></td>
              <td id="table_aula_terça_09_30"></td>
              <td id="table_aula_quarta_09_30"></td>
              <td id="table_aula_quinta_09_30"></td>
              <td id="table_aula_sexta_09_30"></td>
              <td id="table_aula_sabado_09_30"></td>
            </tr>
            <tr class="tr_alunos">
              <td>10:00 - 10:30</td>
              <td id="table_aula_segunda_10_00"></td>
              <td id="table_aula_terça_10_00"></td>
              <td id="table_aula_quarta_10_00"></td>
              <td id="table_aula_quinta_10_00"></td>
              <td id="table_aula_sexta_10_00"></td>
              <td id="table_aula_sabado_10_00"></td>
            </tr>
            <tr class="tr_alunos">
              <td>10:30 - 11:00</td>
              <td id="table_aula_segunda_10_30"></td>
              <td id="table_aula_terça_10_30"></td>
              <td id="table_aula_quarta_10_30"></td>
              <td id="table_aula_quinta_10_30"></td>
              <td id="table_aula_sexta_10_30"></td>
              <td id="table_aula_sabado_10_30"></td>
            </tr>
            <tr class="tr_alunos">
              <td>11:00 - 11:30</td>
              <td id="table_aula_segunda_11_00"></td>
              <td id="table_aula_terça_11_00"></td>
              <td id="table_aula_quarta_11_00"></td>
              <td id="table_aula_quinta_11_00"></td>
              <td id="table_aula_sexta_11_00"></td>
              <td id="table_aula_sabado_11_00"></td>
            </tr>
            <tr class="tr_alunos">
              <td>11:30 - 12:00</td>
              <td id="table_aula_segunda_11_30"></td>
              <td id="table_aula_terça_11_30"></td>
              <td id="table_aula_quarta_11_30"></td>
              <td id="table_aula_quinta_11_30"></td>
              <td id="table_aula_sexta_11_30"></td>
              <td id="table_aula_sabado_11_30"></td>
            </tr>
            <tr class="tr_alunos">
              <td>12:00 - 12:30</td>
              <td id="table_aula_segunda_12_00"></td>
              <td id="table_aula_terça_12_00"></td>
              <td id="table_aula_quarta_12_00"></td>
              <td id="table_aula_quinta_12_00"></td>
              <td id="table_aula_sexta_12_00"></td>
              <td id="table_aula_sabado_12_00"></td>
            </tr>
            <tr class="tr_alunos">
              <td>12:30 - 13:00</td>
              <td id="table_aula_segunda_12_30"></td>
              <td id="table_aula_terça_12_30"></td>
              <td id="table_aula_quarta_12_30"></td>
              <td id="table_aula_quinta_12_30"></td>
              <td id="table_aula_sexta_12_30"></td>
              <td id="table_aula_sabado_12_30"></td>
            </tr>
            <tr class="tr_alunos">
              <td>13:00 - 13:30</td>
              <td id="table_aula_segunda_13_00"></td>
              <td id="table_aula_terça_13_00"></td>
              <td id="table_aula_quarta_13_00"></td>
              <td id="table_aula_quinta_13_00"></td>
              <td id="table_aula_sexta_13_00"></td>
              <td id="table_aula_sabado_13_00"></td>
            </tr>
            <tr class="tr_alunos">
              <td>13:30 - 14:00</td>
              <td id="table_aula_segunda_13_30"></td>
              <td id="table_aula_terça_13_30"></td>
              <td id="table_aula_quarta_13_30"></td>
              <td id="table_aula_quinta_13_30"></td>
              <td id="table_aula_sexta_13_30"></td>
              <td id="table_aula_sabado_13_30"></td>
            </tr>
            <tr class="tr_alunos">
              <td>14:00 - 14:30</td>
              <td id="table_aula_segunda_14_00"></td>
              <td id="table_aula_terça_14_00"></td>
              <td id="table_aula_quarta_14_00"></td>
              <td id="table_aula_quinta_14_00"></td>
              <td id="table_aula_sexta_14_00"></td>
              <td id="table_aula_sabado_14_00"></td>
            </tr>
            <tr class="tr_alunos">
              <td>14:30 - 15:00</td>
              <td id="table_aula_segunda_14_30"></td>
              <td id="table_aula_terça_14_30"></td>
              <td id="table_aula_quarta_14_30"></td>
              <td id="table_aula_quinta_14_30"></td>
              <td id="table_aula_sexta_14_30"></td>
              <td id="table_aula_sabado_14_30"></td>
            </tr>
            <tr class="tr_alunos">
              <td>15:00 - 15:30</td>
              <td id="table_aula_segunda_15_00"></td>
              <td id="table_aula_terça_15_00"></td>
              <td id="table_aula_quarta_15_00"></td>
              <td id="table_aula_quinta_15_00"></td>
              <td id="table_aula_sexta_15_00"></td>
              <td id="table_aula_sabado_15_00"></td>
            </tr>
            <tr class="tr_alunos">
              <td>15:30 - 16:00</td>
              <td id="table_aula_segunda_15_30"></td>
              <td id="table_aula_terça_15_30"></td>
              <td id="table_aula_quarta_15_30"></td>
              <td id="table_aula_quinta_15_30"></td>
              <td id="table_aula_sexta_15_30"></td>
              <td id="table_aula_sabado_15_30"></td>
            </tr>
            <tr class="tr_alunos">
              <td>16:00 - 16:30</td>
              <td id="table_aula_segunda_16_00"></td>
              <td id="table_aula_terça_16_00"></td>
              <td id="table_aula_quarta_16_00"></td>
              <td id="table_aula_quinta_16_00"></td>
              <td id="table_aula_sexta_16_00"></td>
              <td id="table_aula_sabado_16_00"></td>
            </tr>
            <tr class="tr_alunos">
              <td>16:30 - 17:00</td>
              <td id="table_aula_segunda_16_30"></td>
              <td id="table_aula_terça_16_30"></td>
              <td id="table_aula_quarta_16_30"></td>
              <td id="table_aula_quinta_16_30"></td>
              <td id="table_aula_sexta_16_30"></td>
              <td id="table_aula_sabado_16_30"></td>
            </tr>
            <tr class="tr_alunos">
              <td>17:00 - 17:30</td>
              <td id="table_aula_segunda_17_00"></td>
              <td id="table_aula_terça_17_00"></td>
              <td id="table_aula_quarta_17_00"></td>
              <td id="table_aula_quinta_17_00"></td>
              <td id="table_aula_sexta_17_00"></td>
              <td id="table_aula_sabado_17_00"></td>
            </tr>
            <tr class="tr_alunos">
              <td>17:30 - 18:00</td>
              <td id="table_aula_segunda_17_30"></td>
              <td id="table_aula_terça_17_30"></td>
              <td id="table_aula_quarta_17_30"></td>
              <td id="table_aula_quinta_17_30"></td>
              <td id="table_aula_sexta_17_30"></td>
              <td id="table_aula_sabado_17_30"></td>
            </tr>
          </tbody>
        </table>

      </div>

      <div class="legenda_profile">

        <ul>

          <li><span class="cor1">
              <div class="rectangle1"></div>
            </span>recl - Aulas Prátricas</li>
          <li><span class="cor2">
              <div class="rectangle2"></div>
            </span>recl - Aulas téorico</li>

        </ul>
      </div>

      <footer>
        <p>
          Criado <i class="fa fa-heart"></i> por
          André Nunes, Diogo Oliveira, Gustavo Antunes, Sebastião Costa e Tiago Batista
        </p>
      </footer>
    </div>
  </main>
</body>

</html>

<script>

  window.onload = checkCookie();


  fetch('/decrypt-user')
    .then(response => response.json())
    .then(user => {

      //console.log(user);

      document.getElementById('nome').textContent = user.nome;
      document.getElementById('turma').textContent = user.turma;
      document.getElementById('curso').textContent = user.curso;
      document.getElementById('escola').textContent = user.escola;
      valor = user.tipo;
      //console.log(typeof (valor), valor);

      if (valor === 0) {

        //console.log("entrou no if", valor)

        fetch('/perfil/horarios')
          .then(response => {
            return response.json();
          })
          .then(data => {

            //console.log(data);

            // Iterar sobre cada dia da semana
            for (let dia in data) {
              // Iterar sobre cada hora do dia
              for (let hora in data[dia]) {
                //console.log("hora", hora)
                // Iterar sobre cada horário nesse dia e hora
                for (let horario of data[dia][hora]) {

                  const horaSemSegundos = hora.slice(0, -3);
                  const horaFormatada = horaSemSegundos.replace(/:/g, "_");

                  // Selecionar a célula da tabela correspondente a esse dia e hora
                  const cell = document.querySelector(`#table_aula_${dia}_${horaFormatada}`);
                  if (cell) {

                    // Calcular o rowspan com base na duração da aula
                    const inicio = new Date(`2023-01-01T${hora}.000Z`);
                    //console.log("inicio", inicio)
                    const fim = new Date(`2023-01-01T${horario.fim_hora}.000Z`);
                    //console.log("fim", fim)
                    const duracao = (fim - inicio) / (30 * 60 * 1000);
                    //console.log("f i ", fim - inicio)
                    cell.rowSpan = duracao;
                    //console.log("++", duracao)


                    const inicio30 = new Date(`2023-01-01T${hora}.000Z`);

                    for (let i = 1; i < duracao; i++) {
                      inicio30.setMinutes(inicio30.getMinutes() + 30);
                      //console.log("inicio30 : ", inicio30.getHours())    
                      const hora = String(inicio30.getHours()).padStart(2, '0');
                      const minutos = String(inicio30.getMinutes()).padStart(2, '0');
                      const horaFormatada = hora + "_" + minutos;
                      //console.log("horaFormatada : ", horaFormatada) 
                      let tabela = document.getElementById(`table_aula_${dia}_${horaFormatada}`);
                      //console.log("tabela", tabela)
                      if (tabela) {
                        tabela.remove();
                      }
                    }

                    // Preencher a célula com os dados
                    cell.innerHTML = `${horario.aula} - ${horario.nome_prof}<br>${horario.bloco_sala} - Sala - ${horario.nr_sala}`;

                  } else {
                    console.log(`Não foi possível encontrar a célula para o dia ${dia} e a hora ${horaFormatada}`);
                  }

                }
              }
            }
          });

        fetch('/emails')
          .then(response => response.json())
          .then(emails => {

            //console.log(emails);

            const tableBody = document.querySelector('.email-table tbody');
            if (tableBody) { // check if tableBody is not null
              emails.forEach(email => {
                // check if email has from, subject, and text
                if (email.from && email.subject && email.text) {
                  const row = document.createElement('tr');
                  row.innerHTML = `
                        <td>${email.from}</td>
                        <td>${email.subject}</td>
                        <td>${email.text}</td>
                    `;
                  tableBody.appendChild(row);
                }
              });
            } else {
              console.error('Erro: elemento .email-table tbody não encontrado');
            }
          });
      }
      if (valor === 1) {

        //console.log("entrou no if", valor)

        document.getElementById("mail").style.display = "none";


        fetch('/perfil/horarios')
          .then(response => {
            return response.json();
          })
          .then(data => {
            // Iterar sobre cada dia da semana
            for (let dia in data) {
              // Iterar sobre cada hora do dia
              for (let hora in data[dia]) {
                //console.log("hora", hora)
                // Iterar sobre cada horário nesse dia e hora
                for (let horario of data[dia][hora]) {

                  const horaSemSegundos = hora.slice(0, -3);
                  const horaFormatada = horaSemSegundos.replace(/:/g, "_");

                  // Selecionar a célula da tabela correspondente a esse dia e hora
                  const cell = document.querySelector(`#table_aula_${dia}_${horaFormatada}`);
                  if (cell) {

                    // Calcular o rowspan com base na duração da aula
                    const inicio = new Date(`2023-01-01T${hora}.000Z`);
                    //console.log("inicio", inicio)
                    const fim = new Date(`2023-01-01T${horario.fim_hora}.000Z`);
                    //console.log("fim", fim)
                    const duracao = (fim - inicio) / (30 * 60 * 1000);
                    //console.log("f i ", fim - inicio)
                    cell.rowSpan = duracao;
                    //console.log("++", duracao)


                    const inicio30 = new Date(`2023-01-01T${hora}.000Z`);

                    for (let i = 1; i < duracao; i++) {
                      inicio30.setMinutes(inicio30.getMinutes() + 30);
                      //console.log("inicio30 : ", inicio30.getHours())    
                      const hora = String(inicio30.getHours()).padStart(2, '0');
                      const minutos = String(inicio30.getMinutes()).padStart(2, '0');
                      const horaFormatada = hora + "_" + minutos;
                      //console.log("horaFormatada : ", horaFormatada) 
                      let tabela = document.getElementById(`table_aula_${dia}_${horaFormatada}`);
                      //console.log("tabela", tabela)
                      if (tabela) {
                        tabela.remove();
                      }
                    }

                    // Preencher a célula com os dados
                    cell.innerHTML = `${horario.aula} - ${horario.curso}<br>${horario.bloco_sala} - Sala - ${horario.nr_sala}`;

                  } else {
                    console.log(`Não foi possível encontrar a célula para o dia ${dia} e a hora ${horaFormatada}`);
                  }

                }
              }
            }
          });
      }

    });


  // vai buscar o id do modal
  var modal_editar = document.getElementById("modal_editar");
  var modal_mensagem = document.getElementById('modal_mensagem')

  // vai buscar a class do botao para fechar o modal
  var span = document.getElementsByClassName("fechar_editar")[0];

  //fecha o modal quando o botao dentro do modal for clicado
  span.onclick = function () {
    modal_editar.style.display = "none";
  }

  function changeColor() {
    document.getElementById('hoverText').style.color = 'red';
  }

  function resetColor() {
    var bodyStyles = window.getComputedStyle(document.body);
    var currentColor = bodyStyles.getPropertyValue('--text-color');
    document.getElementById('hoverText').style.color = currentColor;
  }

  document.getElementById('change-password-form').addEventListener('submit', function (event) {
    event.preventDefault();

    var pass_antiga = document.querySelector('input[name="pass_antiga"]').value;
    var pass_nova = document.querySelector('input[name="pass_nova"]').value;
    var pass_confirme = document.querySelector('input[name="pass_confirme"]').value;
    var modal_erro = document.getElementById("modal_erro");
    var text = document.getElementById("modalText");

    var data = { pass_antiga, pass_nova, pass_confirme };

    fetch('/change-password', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(data),
    })
      .then(response => {
        // Verifica o código de status da resposta
        if (response.status === 200) {

          // Armazena a mensagem no armazenamento local
          localStorage.setItem('modalMessage', 'Palavra-Passe alterada com sucesso!');
          window.location.href = '/logout';

          return null;

        } else {
          return response.text();
        }
      })
      .then(message => {

        if (message) {
          text.innerHTML = message;
          modal_erro.style.display = "block";

          setTimeout(function () {
            modal_erro.style.display = "none";
          }, 5000);
        }
      })
      .then(data => {
        // Loga o corpo da resposta no console
        console.log('Sucesso:', data);
      })
      .catch((error) => {
        // Loga qualquer erro que ocorra durante a solicitação no console
        console.error('Erro:', error);
      });
  });

</script>